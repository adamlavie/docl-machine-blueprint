tosca_definitions_version: cloudify_dsl_1_3

description: >
  The blueprint describes an OpenStack vm created using Cloudify's OpenStack plugin
  and simple web server started using Cloudify's script plugin.
  In addition, an OpenStack floating ip and security group are created and associated with the created vm.

imports:
  - http://www.getcloudify.org/spec/fabric-plugin/1.4.1/plugin.yaml
  - http://www.getcloudify.org/spec/cloudify/3.4.1/types.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/1.4/plugin.yaml
  - inputs.yaml

inputs:
  image_id:
    description: Openstack image name or id to use for the new server
  flavor_id:
    description: Openstack flavor name or id to use for the new server
  subnet_dns_nameservers:
    default: []
  keystone_username:
    default: ''
  keystone_password:
    default: ''
  keystone_tenant_name:
    default: ''
  keystone_url:
    default: ''
  region:
    default: ''
  skip_openstack_cert_verification:
    default: true
  use_existing_keypair:
    default: ''
  public_key_name:
    default: ''
  ssh_key_filename:
    default: ''
  use_existing_keypair:
    default: ''
  network_name:
    default: ''
  subnet_name:
    default: ''
  port_name:
    default: ''
  router:
    default: ''
  external_network_name:
    default: ''
  security_group_name:
    default: ''
  server_name:
    default: ''
  server_name:
    default: ''
  nova_url:
    default: ''
  neutron_url:
    default: ''
  ssh_user:
    default: ''
  ssh_port:
    default: 22

node_types:

  cloudify.nodes.Docl:
    derived_from: cloudify.nodes.SoftwareComponent
    properties:
      test_paths:
        default: { get_input: test_paths }
      cloudify_manager_blueprints_branch:
        default: { get_input: cloudify_manager_blueprints_branch }
      cloudify_manager_blueprints_org:
        default: { get_input: cloudify_manager_blueprints_org }
      rebuild:
        default: { get_input: rebuild }
      cloudify_packages:
        default:
          - package_name: cloudify-dsl-parser
            branch: { get_input: cloudify_dsl_parser_branch }
            org: { get_input: cloudify_dsl_parser_org }
          - package_name: cloudify-rest-client
            branch: { get_input: cloudify_rest_client_branch }
            org: { get_input: cloudify_rest_client_org }
          - package_name: cloudify-plugins-common
            branch: { get_input: cloudify_plugins_common_branch }
            org: { get_input: cloudify_plugins_common_org }
          - package_name: cloudify-script-plugin
            branch: { get_input: cloudify_script_plugin_branch }
            org: { get_input: cloudify_script_plugin_org }
          - package_name: cloudify-fabric-plugin
            branch: { get_input: cloudify_fabric_plugin_branch }
            org: { get_input: cloudify_fabric_plugin_org }
          - package_name: cloudify-cli
            branch: { get_input: cloudify_cli_branch }
            org: { get_input: cloudify_cli_org }
          - package_name: cloudify-amqp-influxdb
            branch: { get_input: cloudify_amqp_influx_branch }
            org: { get_input: cloudify_amqp_influx_org }
          - package_name: cloudify-agent
            branch: { get_input: cloudify_agent_branch }
            org: { get_input: cloudify_agent_org }
          - package_name: flask-securest
            branch: { get_input: flask_securest_branch }
            org: { get_input: flask_securest_org }
          - package_name: cloudify-diamond-plugin
            branch: { get_input: cloudify_diamond_plugin_branch }
            org: { get_input: cloudify_diamond_plugin_org }
          - package_name: { get_input: docl_package }
            branch: { get_input: docl_branch }
            org: { get_input: docl_org }
          - package_name: cloudify-manager
            branch: { get_input: cloudify_manager_branch }
            org: { get_input: cloudify_manager_org }

dsl_definitions:
  openstack_configuration: &openstack_configuration
    username: { get_input: keystone_username }
    password: { get_input: keystone_password }
    tenant_name: { get_input: keystone_tenant_name }
    auth_url: { get_input: keystone_url }
    region: { get_input: region }
    nova_url: { get_input: nova_url }
    neutron_url: { get_input: neutron_url }
    custom_configuration:
      keystone_client:
        insecure: { get_input: skip_openstack_cert_verification }
      nova_client:
        insecure: { get_input: skip_openstack_cert_verification }
      neutron_client:
        insecure: { get_input: skip_openstack_cert_verification }
      cinder_client:
        insecure: { get_input: skip_openstack_cert_verification }

node_templates:
  keypair:
    type: cloudify.openstack.nodes.KeyPair
    properties:
      use_external_resource: { get_input: use_existing_keypair }
      resource_id: { get_input: public_key_name }
      private_key_path: { get_input: ssh_key_filename }
      openstack_config: *openstack_configuration

  network:
    type: cloudify.openstack.nodes.Network
    properties:
      resource_id: { get_input: network_name }
      openstack_config: *openstack_configuration

  subnet:
    type: cloudify.openstack.nodes.Subnet
    properties:
      resource_id: { get_input: subnet_name }
      subnet:
        ip_version: 4
        cidr: 172.16.0.0/16
        dns_nameservers: { get_input: subnet_dns_nameservers }
      openstack_config: *openstack_configuration
    relationships:
      - target: network
        type: cloudify.relationships.contained_in
      - target: router
        type: cloudify.openstack.subnet_connected_to_router

  port:
    type: cloudify.openstack.nodes.Port
    properties:
      openstack_config: *openstack_configuration
      resource_id: { get_input: port_name }
    relationships:
      - type: cloudify.relationships.contained_in
        target: network
      - type: cloudify.relationships.depends_on
        target: subnet
      - type: cloudify.openstack.port_connected_to_security_group
        target: security_group

  router:
    type: cloudify.openstack.nodes.Router
    properties:
      resource_id: { get_input: router }
      openstack_config: *openstack_configuration
    relationships:
      - target: external_network
        type: cloudify.relationships.connected_to

  external_network:
    type: cloudify.openstack.nodes.Network
    properties:
      use_external_resource: true
      resource_id: { get_input: external_network_name }
      openstack_config: *openstack_configuration

  security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      resource_id: { get_input: security_group_name }
      security_group:
        description: Security group for the VM
      rules:
        - port: 22
          remote_ip_prefix: 0.0.0.0/0
      openstack_config: *openstack_configuration

  server_ip:
    type: cloudify.openstack.nodes.FloatingIP
    properties:
      floatingip:
        floating_network_name: { get_input: external_network_name }
      openstack_config: *openstack_configuration

  host:
    type: cloudify.openstack.nodes.Server
    properties:
      resource_id: { get_input: server_name }
      install_agent: false
      server:
        image: { get_input: image_id }
        flavor: { get_input: flavor_id }
      management_network_name: { get_property: [network, resource_id] }
      openstack_config: *openstack_configuration
    relationships:
      - target: keypair
        type: cloudify.openstack.server_connected_to_keypair
      - target: port
        type: cloudify.openstack.server_connected_to_port
      - target: server_ip
        type: cloudify.openstack.server_connected_to_floating_ip

  docl_node:
    type: cloudify.nodes.Docl
    relationships:
      - type: cloudify.relationships.contained_in
        target: host
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            script_path: scripts/create.py
            hide_output: &hide_output
              - running
            fabric_env: &manager_fabric_env
              user: { get_input: ssh_user }
              port: { get_input: ssh_port }
              key_filename: { get_property: [keypair, private_key_path] }
              host_string: { get_attribute: [server_ip, floating_ip_address] }
        start:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            script_path: scripts/run_tests.py
            fabric_env:
              user: { get_input: ssh_user }
              port: { get_input: ssh_port }
              key_filename: { get_property: [keypair, private_key_path] }
              host_string: { get_attribute: [server_ip, floating_ip_address] }

outputs:
  docl_machine_ip:
    description: Docl endpoint
    value: { get_attribute: [server_ip, floating_ip_address] }
